{
  "hash": "17986ccfa969ab104922e76d3aafe793",
  "result": {
    "markdown": "---\ntitle: \"Differential gene expression\"\n---\n\n\n## Material\n\n\n{{< downloadthis ../assets/pdf/DGE_and_enrichment_analysis.pdf dname=\"DGE_and_enrichment_analysis\" label=\"Download the presentation\" icon=\"filetype-pdf\" >}}\n\n\n{{< video https://youtu.be/6Y5uCQWRRbg?si=mcV9qJUap1qvFjy3 >}}\n\n\n\n-   More information on [pseudobulk analysis](https://bioconductor.org/books/3.17/OSCA.multisample/multi-sample-comparisons.html)\n-   [Muscat](https://bioconductor.org/packages/release/bioc/html/muscat.html) for pseudobulk DGE.\n-   [Paper](https://www.nature.com/articles/nmeth.4612) on the robustness of different differential expression analysis methods\n\n## Exercises\n\n### Find all markers for each cluster\n\nLoad the `seu` dataset you have created yesterday:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-1_7b5be00ae5fb57890e9b1725e21dc90f'}\n\n```{.r .cell-code}\nseu <- readRDS(\"seu_day2-4.rds\")\n```\n:::\n\n\nAnd load the following packages (install them if they are missing):\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-2_d5d8b878b2719bd4997b3131c2bfeca8'}\n\n```{.r .cell-code}\nlibrary(Seurat)\nlibrary(edgeR) # BiocManager::install(\"edgeR\")\nlibrary(limma)\nlibrary(dplyr)\nlibrary(scuttle)\n```\n:::\n\n\nThe function `FindAllMarkers` performs a Wilcoxon plot to determine the genes differentially expressed between each cluster and the rest of the cells. Other types of tests than the Wilcoxon test are available. Check it out by running `?Seurat::FindAllMarkers`.\n\nNow run analysis:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-3_3cc0bde14d582ac643f2345be0051aeb'}\n\n```{.r .cell-code}\nde_genes <- Seurat::FindAllMarkers(seu,  min.pct = 0.25,\n                                   only.pos = TRUE)\n```\n:::\n\n\nSubset the table to only keep the significant genes, and you can save it as a csv file if you wish to explore it further. Then extract the top 3 markers per cluster:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-4_100f084b6ed2c9f86532f2719f1ea00a'}\n\n```{.r .cell-code}\nde_genes <- subset(de_genes, de_genes$p_val_adj < 0.05)\nwrite.csv(de_genes,\n          \"de_genes_FindAllMarkers.csv\",\n          row.names = F, quote = F)\n\ntop_specific_markers <- de_genes %>%\n  group_by(cluster) %>%\n  top_n(3, avg_log2FC)\n```\n:::\n\n\nAnd generate e.g. a dotplot:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-5_05b1fbba5a15a64011f0a93a2d94a043'}\n\n```{.r .cell-code}\ndittoSeq::dittoDotPlot(seu,\n                       vars = unique(top_specific_markers$gene), \n                       group.by = \"RNA_snn_res.0.3\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise\n\nWhat are significant marker genes in cluster 0 and 8? Are the T cell genes in there?\n:::\n\n::: callout-hint\nYou can re-load the vector with immune genes with:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-6_732b0cc554e2913afa219a2dbfc2d272'}\n\n```{.r .cell-code}\ntcell_genes <- c(\"IL7R\", \"LTB\", \"TRAC\", \"CD3D\")\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-7_457614cc311b7b22851d7cf1b5d864ab'}\n\n```{.r .cell-code}\nde_genes[de_genes$gene %in% tcell_genes,] |> knitr::kable()\n```\n\n::: {.cell-output-display}\n|      | p_val| avg_log2FC| pct.1| pct.2| p_val_adj|cluster |gene |\n|:-----|-----:|----------:|-----:|-----:|---------:|:-------|:----|\n|CD3D  |     0|  2.9050191| 0.770| 0.227|         0|0       |CD3D |\n|TRAC  |     0|  2.5859745| 0.627| 0.202|         0|0       |TRAC |\n|LTB   |     0|  1.8698016| 0.759| 0.395|         0|0       |LTB  |\n|IL7R  |     0|  2.8974760| 0.438| 0.114|         0|0       |IL7R |\n|LTB1  |     0|  1.3878665| 0.678| 0.465|         0|7       |LTB  |\n|TRAC1 |     0|  2.3761801| 0.744| 0.274|         0|8       |TRAC |\n|CD3D1 |     0|  2.1009702| 0.799| 0.325|         0|8       |CD3D |\n|LTB2  |     0|  1.8673679| 0.761| 0.461|         0|8       |LTB  |\n|IL7R1 |     0|  1.8831338| 0.460| 0.172|         0|8       |IL7R |\n|LTB3  |     0|  0.9176413| 0.749| 0.466|         0|10      |LTB  |\n:::\n:::\n\n\nSo, yes, the T-cell genes are highly significant markers for cluster 0 and 8.\n:::\n\n### Differential expression between groups of cells\n\nThe `FindMarkers` function allows to test for differential gene expression analysis specifically between 2 groups of cells, i.e. perform pairwise comparisons, eg between cells of cluster 0 vs cluster 2, or between cells annotated as T-cells and B-cells.\n\nFirst we can set the default cell identity to the cell types defined by `SingleR`:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-8_e3f8d284c3aaf1bb6db6d1bfbefb41cc'}\n\n```{.r .cell-code}\nseu <- Seurat::SetIdent(seu, value = \"SingleR_annot\")\n```\n:::\n\n\nRun the differential gene expression analysis and subset the table to keep the significant genes:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-9_daca451380a856cbb03d3f56a7a65b25'}\n\n```{.r .cell-code}\ndeg_cd8_cd4 <- Seurat::FindMarkers(seu,\n                                   ident.1 = \"CD8+ T cells\",\n                                   ident.2 = \"CD4+ T cells\",\n                                   group.by = seu$SingleR_annot,\n                                   test.use = \"wilcox\")\ndeg_cd8_cd4 <- subset(deg_cd8_cd4, deg_cd8_cd4$p_val_adj<0.05)\n```\n:::\n\n\n::: callout-important\n## Exercise\n\nAre CD8A, CD8B and CD4 in there? What does the sign (i.e. positive or negative) mean in the log fold change values? Are they according to the CD8+ and CD4+ annotations? Check your answer by generating a violin plot of a top differentially expressed gene.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\nYou can check out the results with:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-10_4f6249637b5c6b01feab476c3dbdc316'}\n\n```{.r .cell-code}\nView(deg_cd8_cd4)\n```\n:::\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-11_3879d79add28d336609ee92dd5c923e0'}\n::: {.cell-output-display}\n|              |   p_val| avg_log2FC| pct.1| pct.2| p_val_adj|\n|:-------------|-------:|----------:|-----:|-----:|---------:|\n|CD8A          | 0.0e+00|  5.8036617| 0.336| 0.008| 0.0000000|\n|CTSW          | 0.0e+00|  3.4118773| 0.276| 0.030| 0.0000000|\n|CCL5          | 0.0e+00|  4.2922622| 0.285| 0.062| 0.0000000|\n|CD8B          | 0.0e+00|  1.3123538| 0.470| 0.178| 0.0000000|\n|NKG7          | 0.0e+00|  4.5376500| 0.225| 0.037| 0.0000000|\n|CST7          | 0.0e+00|  4.4123574| 0.143| 0.012| 0.0000000|\n|GZMA          | 0.0e+00|  3.8501654| 0.169| 0.025| 0.0000000|\n|TRGC2         | 0.0e+00|  3.4931638| 0.144| 0.018| 0.0000000|\n|RPS27         | 0.0e+00| -0.1820605| 1.000| 1.000| 0.0000000|\n|KLRD1         | 0.0e+00|  4.3589947| 0.108| 0.008| 0.0000000|\n|ID2           | 0.0e+00|  0.8632969| 0.565| 0.353| 0.0000000|\n|GZMK          | 0.0e+00|  3.0113231| 0.130| 0.022| 0.0000000|\n|HCST          | 0.0e+00|  0.7949700| 0.681| 0.495| 0.0000000|\n|MT-CO1        | 0.0e+00|  0.3243268| 0.989| 0.979| 0.0000000|\n|TRGC1         | 0.0e+00|  3.6853476| 0.110| 0.013| 0.0000000|\n|FHIT          | 0.0e+00| -1.6706990| 0.110| 0.273| 0.0000000|\n|RP11-291B21.2 | 0.0e+00|  1.3507107| 0.222| 0.077| 0.0000000|\n|MT-ND4        | 0.0e+00|  0.3226206| 0.963| 0.932| 0.0000000|\n|CD4           | 0.0e+00| -3.3247772| 0.011| 0.105| 0.0000000|\n|MT-CO2        | 0.0e+00|  0.2401784| 0.993| 0.995| 0.0000000|\n|TRDC          | 0.0e+00|  2.6894608| 0.105| 0.019| 0.0000000|\n|CRTAM         | 0.0e+00|  3.7124154| 0.068| 0.003| 0.0000000|\n|PECAM1        | 0.0e+00|  2.6701767| 0.096| 0.015| 0.0000000|\n|LYAR          | 0.0e+00|  1.6580580| 0.198| 0.076| 0.0000000|\n|GZMH          | 0.0e+00|  4.8543018| 0.067| 0.003| 0.0000000|\n|PRF1          | 0.0e+00|  2.8596139| 0.099| 0.018| 0.0000000|\n|ACTB          | 0.0e+00|  0.3093718| 0.965| 0.925| 0.0000000|\n|AC092580.4    | 0.0e+00|  1.3359936| 0.173| 0.061| 0.0000000|\n|CCL4          | 0.0e+00|  3.7724347| 0.118| 0.031| 0.0000001|\n|RPS27A        | 0.0e+00| -0.1605123| 1.000| 1.000| 0.0000001|\n|RPL11         | 0.0e+00| -0.1685948| 1.000| 1.000| 0.0000002|\n|KLRC1         | 0.0e+00|  8.3089065| 0.048| 0.000| 0.0000004|\n|MT-CO3        | 0.0e+00|  0.2753652| 0.966| 0.954| 0.0000005|\n|TPST2         | 0.0e+00|  1.8352805| 0.137| 0.045| 0.0000009|\n|RUNX3         | 0.0e+00|  1.0535174| 0.180| 0.071| 0.0000009|\n|HLA-B         | 0.0e+00|  0.3203112| 0.970| 0.934| 0.0000012|\n|RPL21         | 0.0e+00| -0.1713527| 1.000| 1.000| 0.0000012|\n|MT-ND2        | 0.0e+00|  0.2971960| 0.958| 0.918| 0.0000013|\n|RPS29         | 0.0e+00| -0.1172011| 1.000| 1.000| 0.0000032|\n|GNLY          | 0.0e+00|  3.8610459| 0.132| 0.046| 0.0000038|\n|IL32          | 0.0e+00|  0.5401192| 0.739| 0.624| 0.0000060|\n|FAM173A       | 0.0e+00|  1.1506784| 0.194| 0.087| 0.0000076|\n|NR4A2         | 0.0e+00|  0.8415276| 0.341| 0.203| 0.0000094|\n|IL2RB         | 0.0e+00|  2.2000968| 0.078| 0.015| 0.0000148|\n|HOPX          | 0.0e+00|  2.3701004| 0.089| 0.022| 0.0000197|\n|CXCR3         | 0.0e+00|  2.4269612| 0.072| 0.013| 0.0000234|\n|RPL30         | 0.0e+00| -0.1749260| 0.992| 0.998| 0.0000259|\n|PLEK          | 0.0e+00|  2.7963063| 0.059| 0.008| 0.0000327|\n|CBLB          | 0.0e+00|  1.2237121| 0.127| 0.045| 0.0000494|\n|RPS25         | 0.0e+00| -0.1727553| 1.000| 1.000| 0.0000532|\n|BZW1          | 0.0e+00|  0.7778875| 0.354| 0.223| 0.0000597|\n|RPL34         | 0.0e+00| -0.1552375| 1.000| 1.000| 0.0000684|\n|MT-ND3        | 0.0e+00|  0.2539291| 0.955| 0.930| 0.0000920|\n|ACTG1         | 0.0e+00|  0.4120757| 0.744| 0.622| 0.0001017|\n|RPL31         | 0.0e+00| -0.1426997| 1.000| 0.998| 0.0001340|\n|CD160         | 0.0e+00|  4.6296720| 0.042| 0.002| 0.0001448|\n|NT5E          | 0.0e+00|  4.1692640| 0.042| 0.002| 0.0001452|\n|TRAT1         | 0.0e+00| -1.2378085| 0.135| 0.242| 0.0001694|\n|RPL35A        | 0.0e+00| -0.1498209| 0.999| 0.999| 0.0001911|\n|RPL32         | 0.0e+00| -0.1349986| 1.000| 1.000| 0.0001959|\n|MAL           | 0.0e+00| -1.0983742| 0.149| 0.257| 0.0001977|\n|MATK          | 0.0e+00|  1.5714195| 0.092| 0.026| 0.0002149|\n|CD40LG        | 0.0e+00| -1.9356543| 0.020| 0.087| 0.0002240|\n|TGFBR3        | 0.0e+00|  3.2149127| 0.047| 0.004| 0.0003054|\n|CLIC3         | 0.0e+00|  2.7202513| 0.054| 0.008| 0.0004215|\n|JUN           | 0.0e+00|  0.5742398| 0.681| 0.588| 0.0004373|\n|KLRC4         | 0.0e+00|  3.3549690| 0.048| 0.005| 0.0005192|\n|RPS23         | 0.0e+00| -0.1485187| 1.000| 1.000| 0.0005639|\n|TMSB10        | 0.0e+00| -0.1783588| 0.996| 0.999| 0.0006274|\n|IFRD1         | 0.0e+00|  0.7876254| 0.303| 0.182| 0.0006301|\n|ICOS          | 1.0e-07| -1.8295856| 0.035| 0.107| 0.0009510|\n|MT-ATP6       | 1.0e-07|  0.2791020| 0.932| 0.902| 0.0009630|\n|XCL2          | 1.0e-07|  5.1473347| 0.035| 0.001| 0.0009734|\n|LITAF         | 1.0e-07|  0.6455639| 0.407| 0.277| 0.0010564|\n|KLRC2         | 1.0e-07|  4.5769235| 0.038| 0.002| 0.0011382|\n|LAG3          | 1.0e-07|  2.6152771| 0.054| 0.009| 0.0012129|\n|KLRG1         | 1.0e-07|  1.8532056| 0.103| 0.037| 0.0013752|\n|IFNG          | 1.0e-07|  3.4727589| 0.051| 0.008| 0.0013816|\n|RPS15A        | 1.0e-07| -0.1390132| 1.000| 1.000| 0.0014859|\n|MT1F          | 1.0e-07|  1.8145433| 0.086| 0.026| 0.0015767|\n|S100B         | 1.0e-07|  2.0010809| 0.105| 0.038| 0.0018264|\n|LCP1          | 1.0e-07|  0.7192442| 0.312| 0.198| 0.0021165|\n|MT-CYB        | 1.0e-07|  0.2155921| 0.959| 0.958| 0.0021248|\n|GZMB          | 1.0e-07|  4.7551476| 0.037| 0.002| 0.0021433|\n|HLA-DPB1      | 2.0e-07|  0.9458630| 0.210| 0.113| 0.0028339|\n|MAP3K8        | 2.0e-07|  2.3308513| 0.058| 0.012| 0.0037843|\n|STK17A        | 3.0e-07|  0.6044699| 0.426| 0.306| 0.0049752|\n|ZFP36         | 3.0e-07|  0.6981065| 0.394| 0.276| 0.0052431|\n|A1BG          | 3.0e-07|  0.9879067| 0.147| 0.068| 0.0052530|\n|ACTN4         | 3.0e-07|  1.6884121| 0.074| 0.021| 0.0057168|\n|GZMM          | 3.0e-07|  0.5590226| 0.354| 0.231| 0.0057598|\n|RPL13A        | 3.0e-07| -0.1027637| 1.000| 1.000| 0.0062383|\n|ABCB1         | 4.0e-07|  2.0901339| 0.057| 0.012| 0.0067877|\n|DUSP2         | 4.0e-07|  1.0251535| 0.319| 0.213| 0.0069206|\n|ARPC5L        | 4.0e-07|  0.8444989| 0.173| 0.087| 0.0071525|\n|CORO1B        | 4.0e-07| -1.2457970| 0.122| 0.209| 0.0072482|\n|C12orf75      | 5.0e-07|  0.9457620| 0.200| 0.111| 0.0086192|\n|RPL18         | 5.0e-07| -0.1498451| 0.982| 0.988| 0.0088652|\n|RPS8          | 5.0e-07| -0.1596945| 1.000| 0.999| 0.0091967|\n|B2M           | 5.0e-07|  0.1532571| 1.000| 1.000| 0.0095932|\n|MT-ND1        | 5.0e-07|  0.2998300| 0.843| 0.791| 0.0098249|\n|RPL37         | 6.0e-07| -0.1315823| 0.999| 0.999| 0.0103264|\n|TSPAN32       | 6.0e-07|  1.2568587| 0.123| 0.054| 0.0103422|\n|GPR183        | 6.0e-07| -0.9248264| 0.116| 0.209| 0.0103973|\n|CCR7          | 6.0e-07| -0.8769143| 0.244| 0.343| 0.0113471|\n|SRGN          | 6.0e-07|  0.7042011| 0.467| 0.360| 0.0117323|\n|RPL5          | 7.0e-07| -0.1568235| 0.983| 0.989| 0.0121481|\n|RPL38         | 7.0e-07| -0.1604085| 0.989| 0.993| 0.0123553|\n|CYBA          | 7.0e-07|  0.4154226| 0.680| 0.582| 0.0136535|\n|DUSP1         | 8.0e-07|  0.5137168| 0.688| 0.582| 0.0155765|\n|TBX21         | 9.0e-07|  3.9258636| 0.033| 0.002| 0.0168414|\n|XCL1          | 9.0e-07|  4.2021279| 0.033| 0.002| 0.0169279|\n|LINC00152     | 1.1e-06|  1.4174424| 0.102| 0.041| 0.0197132|\n|HLA-A         | 1.1e-06|  0.3019478| 0.891| 0.845| 0.0198546|\n|NSMAF         | 1.1e-06|  1.5192786| 0.067| 0.019| 0.0207285|\n|SCCPDH        | 1.2e-06|  1.6248603| 0.068| 0.020| 0.0218906|\n|RPS17         | 1.2e-06| -0.1449256| 0.999| 0.999| 0.0226365|\n|NCR3          | 1.4e-06|  1.5189519| 0.074| 0.023| 0.0254304|\n|HLA-C         | 1.8e-06|  0.2515121| 0.907| 0.859| 0.0341751|\n|TSPYL2        | 1.9e-06|  0.5852828| 0.269| 0.168| 0.0349308|\n|AP3M2         | 2.0e-06| -1.6253908| 0.071| 0.143| 0.0370676|\n|PRR5          | 2.1e-06|  1.9492113| 0.075| 0.025| 0.0399115|\n|RPL36A        | 2.3e-06| -0.2223425| 0.989| 0.990| 0.0436935|\n|FCRL6         | 2.5e-06|  6.1868906| 0.024| 0.000| 0.0464487|\n|ADTRP         | 2.5e-06| -2.8470196| 0.010| 0.053| 0.0466904|\n|BIRC3         | 2.6e-06| -1.4864265| 0.071| 0.143| 0.0489079|\n:::\n:::\n\n\nFor an explanation of the log fold change have a look at `?Seurat::FindMarkers`. At **Value** it says:\n\n> `avg_logFC`: log fold-chage of the average expression between the two groups. Positive values indicate that the gene is more highly expressed in the first group\n\nTo view CD8A, CD8B and CD4:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-12_1a76d680a333a37f0d572651b7775315'}\n\n```{.r .cell-code}\ndeg_cd8_cd4[c(\"CD4\", \"CD8A\", \"CD8B\"),]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            p_val avg_log2FC pct.1 pct.2    p_val_adj\nCD4  2.290800e-14  -3.324777 0.011 0.105 4.277611e-10\nCD8A 2.889582e-74   5.803662 0.336 0.008 5.395717e-70\nCD8B 3.756143e-34   1.312354 0.470 0.178 7.013846e-30\n```\n:::\n:::\n\n\nIndeed, because we compared ident.1 = \"CD8+ T cells\" to ident.2 = \"CD4+ T cells\", a negative log2FC for the CD4 gene indicates a lower expression in CD8+ T-cells than in CD4+ T-cells, while a positive log2FC for the CD8A and CD8B genes indicates a higher expression in CD8+ T-cells.\n\nPlotting the genes in these two T-cell groups only:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-13_d2213611fe4d722092df8dd84126db5d'}\n\n```{.r .cell-code}\nSeurat::VlnPlot(seu, \n            features = c(\"CD4\", \"CD8A\", \"CD8B\"),\n            idents = c(\"CD8+ T cells\", \"CD4+ T cells\"))\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n:::\n\n### Differential expression using `limma`\n\nThe Wilcoxon test implemented in `FindMarkers` does not allow you to test for complex design (eg factorial experiments) or to include batch as a covariate. It doesn't allow you to run paired-sample T tests for example.\n\nFor more complex designs, we can use `edgeR` or `limma` which are designed for microarray or bulk RNA seq data and provide a design matrix that includes covariates for example, or sample IDs for paired analyses.\n\nWe will load an object containing only pro B cells, both from healthy tissues (PBMMC), and malignant tissues (ETV6-RUNX1).\n\n::: callout-warning\nPlease NOTE that in the original design of this data set, the healthy and malignant tissues were not patient-matched, i.e. the real design was not the one of paired healthy and malignant tissues. However, for demonstration purposes, we will show you how to run a paired analysis, and do as if the PBMMC-1 and ETV6-RUNX1-1 samples both came from the same patient 1, the PBMMC-2 and ETV6-RUNX1-2 samples both came from the same patient 2, etc...\n:::\n\nWe can load the object and explore its UMAP and meta.data like this:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-14_b6d93997907443e12491642269ce87e2'}\n\n```{.r .cell-code}\nproB <- readRDS(\"course_data/proB.rds\")\n\nSeurat::DimPlot(proB, group.by = \"orig.ident\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntable(proB@meta.data$type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nETV6-RUNX1      PBMMC \n      2000       1021 \n```\n:::\n\n```{.r .cell-code}\nhead(proB@meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                           orig.ident nCount_RNA nFeature_RNA    SingleR_annot\nPBMMC-1_AAATGCCAGACTGGGT-1    PBMMC-1       4886         1727 Pro-B_cell_CD34+\nPBMMC-1_AAATGCCTCCACTGGG-1    PBMMC-1       8397         2291 Pro-B_cell_CD34+\nPBMMC-1_AACACGTTCTTGACGA-1    PBMMC-1       3444         1204 Pro-B_cell_CD34+\nPBMMC-1_AACCATGAGAAGGTGA-1    PBMMC-1       8981         2437 Pro-B_cell_CD34+\nPBMMC-1_AACCGCGCATGGTCAT-1    PBMMC-1       3719         1368 Pro-B_cell_CD34+\nPBMMC-1_AAGCCGCCAGACGTAG-1    PBMMC-1       4573         1464 Pro-B_cell_CD34+\n                            type\nPBMMC-1_AAATGCCAGACTGGGT-1 PBMMC\nPBMMC-1_AAATGCCTCCACTGGG-1 PBMMC\nPBMMC-1_AACACGTTCTTGACGA-1 PBMMC\nPBMMC-1_AACCATGAGAAGGTGA-1 PBMMC\nPBMMC-1_AACCGCGCATGGTCAT-1 PBMMC\nPBMMC-1_AAGCCGCCAGACGTAG-1 PBMMC\n```\n:::\n:::\n\n\n::: callout-note\nIf you want to know how this pro-B cell subset is generated, have a look at the script [here](https://raw.githubusercontent.com/sib-swiss/single-cell-training/master/scripts/generate_object_proB.R).\n:::\n\n\nLet's have a look at the UMAP (again), coloured by celltype:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-15_d8416f79b24d92a3484055efe7362730'}\n\n```{.r .cell-code}\nSeurat::DimPlot(proB, group.by = \"type\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nLet's say we are specifically interested to test for differential gene expression between the tumor and normal samples.\n\n::: callout-note\nHere we could also test for e.g. healthy versus diseased within a celltype/cluster.\n:::\n\nNow we will run differential expression analysis between tumor and healthy cells using the patient ID as a covariate by using `limma`.\n\nPrepare the pseudobulk count matrix:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-16_475f54c6ccfcaa9c1bcfe4a2471ddf6d'}\n\n```{.r .cell-code}\n#taking the proB data \nSeurat::DefaultAssay(proB) <- \"RNA\"\nSeurat::Idents(proB) <- proB$orig.ident\n\n## add the patient id also for paired DGE\nproB$patient.id<-gsub(\"ETV6-RUNX1\", \"ETV6_RUNX1\", proB$orig.ident)\nproB$patient.id<-sapply(strsplit(proB$patient.id, \"-\"), '[', 2)\n\n## Here we do perform pseudo-bulk:\n##first a mandatory column of sample needs to be added to the meta data that is the grouping factor, should be the samples\nproB$sample <- factor(proB$orig.ident)\n\n# aggergate the cells per sampple\nbulk <- Seurat::AggregateExpression(proB, group.by = \"sample\",\n                                    return.seurat = TRUE,\n                                    assay = \"RNA\")\n\n# create a metadata data frame based on the aggregated cells\nmeta_data <- unique(proB@meta.data[, c(\"orig.ident\",\n                                            \"sample\", \"type\",\n                                            \"patient.id\")])\nrownames(meta_data) <- meta_data$orig.ident\nbulk@meta.data <- meta_data[colnames(bulk), ]\n```\n:::\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-17_e389673a5596607d7e4a8f7969518385'}\n\n```{.r .cell-code}\n##have a look at the counts\ncounts <- Seurat::GetAssayData(bulk, layer = \"counts\") |> as.matrix()\n\nhead(counts)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n              ETV6-RUNX1-1 ETV6-RUNX1-2 ETV6-RUNX1-3 PBMMC-1 PBMMC-2 PBMMC-3\nRP11-34P13.7             0            0            0       2       0       0\nFO538757.3               0            0            0       0       0       0\nFO538757.2             138          275           74     129      40     112\nAP006222.2              63           43           17      38      19      26\nRP4-669L17.10            5           10            3       0       1       1\nRP5-857K21.4             0            0            0       0       0       2\n```\n:::\n\n```{.r .cell-code}\n#have a look at the colData of our new object summed, can you see type and \n#patient.id are there\nhead(bulk@meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               orig.ident       sample       type patient.id\nETV6-RUNX1-1 ETV6-RUNX1-1 ETV6-RUNX1-1 ETV6-RUNX1          1\nETV6-RUNX1-2 ETV6-RUNX1-2 ETV6-RUNX1-2 ETV6-RUNX1          2\nETV6-RUNX1-3 ETV6-RUNX1-3 ETV6-RUNX1-3 ETV6-RUNX1          3\nPBMMC-1           PBMMC-1      PBMMC-1      PBMMC          1\nPBMMC-2           PBMMC-2      PBMMC-2      PBMMC          2\nPBMMC-3           PBMMC-3      PBMMC-3      PBMMC          3\n```\n:::\n:::\n\n\nGenerate a `DGEList` object to use as input for `limma` and filter the genes to remove lowly expressed genes. How many are left?\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-18_37528d9c9d8e78a0bc0356bedd37861e'}\n\n```{.r .cell-code}\n#As in the standard limma analysis generate a DGE object\n\ny <- edgeR::DGEList(counts, samples = bulk@meta.data)\n\n##filter lowly expressed (recommanded for limma)\nkeep <- edgeR::filterByExpr(y, group = bulk$type)\ny <- y[keep,]\n\n##see how many genes were kept \nsummary(keep)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Mode   FALSE    TRUE \nlogical   11086   10017 \n```\n:::\n:::\n\n\nGenerate a design matrix, including patient ID to model for a paired analysis. If you need help to generate a design matrix, check out the very nice [edgeR User Guide](https://bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf), sections 3.3 and 3.4. Extract the sample ID from the meta.data, then create the design matrix:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-19_13154c14dec988f7bae4c63c0bf1b103'}\n\n```{.r .cell-code}\n## Create the design matrix and include the technology as a covariate:\ndesign <- model.matrix(~0 + y$samples$type + y$samples$patient.id)\n\n# Have a look\ndesign\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  y$samples$typeETV6-RUNX1 y$samples$typePBMMC y$samples$patient.id2\n1                        1                   0                     0\n2                        1                   0                     1\n3                        1                   0                     0\n4                        0                   1                     0\n5                        0                   1                     1\n6                        0                   1                     0\n  y$samples$patient.id3\n1                     0\n2                     0\n3                     1\n4                     0\n5                     0\n6                     1\nattr(,\"assign\")\n[1] 1 1 2 2\nattr(,\"contrasts\")\nattr(,\"contrasts\")$`y$samples$type`\n[1] \"contr.treatment\"\n\nattr(,\"contrasts\")$`y$samples$patient.id`\n[1] \"contr.treatment\"\n```\n:::\n\n```{.r .cell-code}\n# change column/rownames names to more simple group names: \ncolnames(design) <- make.names(c(\"ETV6-RUNX1\", \"PBMMC\",\"patient2\",\"patient3\"))\nrownames(design) <- rownames(y$samples)\n```\n:::\n\n\nSpecify which contrast to analyse:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-20_0771634dd03a38f8eeef1535a9920998'}\n\n```{.r .cell-code}\ncontrast.mat <- limma::makeContrasts(ETV6.RUNX1 - PBMMC,\n                                     levels = design)\n```\n:::\n\n\nFirt, we perform TMM normalization using edgeR, and then `limma` can perform the transformation with `voom`, fit the model, compute the contrasts and compute test statistics with `eBayes`:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-21_7e4263d164a0d471337288891626cc93'}\n\n```{.r .cell-code}\ndge <- edgeR::calcNormFactors(y)  \n\n#Do limma\nvm <- limma::voom(dge, design = design, plot = TRUE)\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfit <- limma::lmFit(vm, design = design)\nfit.contrasts <- limma::contrasts.fit(fit, contrast.mat)\nfit.contrasts <- limma::eBayes(fit.contrasts)\n```\n:::\n\n\nWe can use `topTable` to get the most significantly differentially expressed genes, and save the full DE results to an object. How many genes are significant? Are you suprised by this number?\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-22_2d33da2b644c15e9d064b14c4a8c8f84'}\n\n```{.r .cell-code}\n# Show the top differentially expressed genes:\nlimma::topTable(fit.contrasts, number = 10, sort.by = \"P\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               logFC  AveExpr         t      P.Value    adj.P.Val        B\nRPS4Y2      5.346800 6.347826  15.39674 3.361453e-08 0.0001152727 9.477129\nSDC2        9.070465 2.708711  15.33434 3.493119e-08 0.0001152727 7.681010\nIGLL1      -3.788160 9.287148 -15.19483 3.808426e-08 0.0001152727 9.465422\nCTGF        4.368363 6.029640  14.89301 4.603081e-08 0.0001152727 9.141505\nAP005530.2  8.770808 2.560369  14.27130 6.879238e-08 0.0001335825 7.294079\nGNG11       3.500250 6.457777  13.70183 1.008304e-07 0.0001335825 8.495288\nHLA-DQA1    2.982748 7.410939  13.39202 1.249067e-07 0.0001335825 8.287394\nPTP4A3      3.734865 5.449894  13.23439 1.395246e-07 0.0001335825 8.126807\nCD27        4.115561 5.843582  13.23011 1.399471e-07 0.0001335825 8.147433\nALOX5       4.142010 5.682900  13.16658 1.463814e-07 0.0001335825 8.098199\n```\n:::\n\n```{.r .cell-code}\nlimma_de <- limma::topTable(fit.contrasts, number = Inf, sort.by = \"P\")\nlength(which(limma_de$adj.P.Val<0.05))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2738\n```\n:::\n:::\n\n\nAnd we can check whether this corresponds to the counts by generating a violin plot, or a gene downregulated in tumor, or a gene upregulated in tumor:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-23_38ca73fd9846ec8b4069f6a094a70e0d'}\n\n```{.r .cell-code}\nSeurat::VlnPlot(proB, \"S100A9\", split.by = \"type\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n\n```{.r .cell-code}\nSeurat::VlnPlot(proB, \"SOCS2\", split.by = \"type\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-23-2.png){width=672}\n:::\n:::\n\n\nWe can run a similar analysis with `Seurat`, but this will not take into account the paired design. Run the code below.\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-24_779246c4f24ee4b348397dde88a8e262'}\n\n```{.r .cell-code}\ntum_vs_norm <- Seurat::FindMarkers(proB, \n                                   ident.1 = \"ETV6-RUNX1\", \n                                   ident.2 = \"PBMMC\", \n                                   group.by = \"type\")\ntum_vs_norm <- subset(tum_vs_norm, tum_vs_norm$p_val_adj<0.05)\n```\n:::\n\n\n::: callout-important\n## Exercise (extra)\n\nHow many genes are significant? How does the fold change of these genes compare to the fold change of the top genes found by limma?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-25_33d91deabbd4a03e8f97ba797bc66e06'}\n\n```{.r .cell-code}\ndim(tum_vs_norm) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 3820    5\n```\n:::\n:::\n\n\nWe find 3820 significant genes. If we merge the `FindMarkers` and the `limma` results, keep `limma`'s most significant genes and plot:\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-26_a3e73bd9f7eb0e26cdefccca97583422'}\n\n```{.r .cell-code}\nmerge_limma_FindMarkers <- merge(tum_vs_norm, limma_de, by=\"row.names\",\n                           all.x=T)\n\npar(mar=c(4,4,4,4))\nplot(merge_limma_FindMarkers$avg_log2FC,\n    merge_limma_FindMarkers$logFC,\n    xlab=\"log2FC Wilcoxon\", ylab=\"log2FC limma\",\n    pch=15, cex=0.5)\nabline(a=0, b=1, col=\"red\")\n```\n\n::: {.cell-output-display}\n![](day3-1_differential_gene_expression_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n:::\n\n::: callout-warning\n## Keep the object\n\nKeep the `tum_vs_norm` and `limma_de` objects because we will use this output later for the enrichment analysis in the next section.\n:::\n\n\n::: {.cell hash='day3-1_differential_gene_expression_cache/html/unnamed-chunk-27_2f1965f475d43c7268a94f9e06bca537'}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}